name: ZED Test Automation (Master)
on:
  repository_dispatch:
  push:
    branches:
      - lipsa/runsuite
    tags:
      - '*.*.*'
  schedule:
    - cron: '0 0 * * *'  # every day at midnight

  #repository_dispatch:
  #push:
env:
  # Force terminal colors. @see https://www.npmjs.com/package/colors
  FORCE_COLOR: 1

jobs:
  e2e-tests:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: microsoft/playwright-github-action@v1
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '14.x'
      - name: Use NPM
        if: always()
        # if: github.event.action == 'ping'
        run: |
          echo "action '${{ github.event.action }}' "
          echo "repository '${{ github.event.client_payload.repository }}' "
          npm ci
          npm install
          npm update
        env:
          CI: true
      - name: Use Commit ID
        if: always()
        run: |
          variable=$(git rev-parse --short HEAD)
          echo "Last commit registred:" $variable
        env:
          CI: true
      - name: Run test when have event ping
        if: ${{ always()}}
        run: xvfb-run --auto-servernum -- npm run test -- --verbose
        env:
          CI: true
      - name: Get Allure history
        uses: actions/checkout@v2
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      - name: Allure Report action from marketplace
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
      - name: Deploying Allure Report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.ACCESS_TOKEN }}
          publish_branch: gh-pages
          allow_empty_commit: true
          publish_dir: allure-history
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: ${{ github.event.head_commit.message }}
          tag_name: ${{ steps.prepare_tag.outputs.deploy_tag_name }}
          tag_message: 'Deployment ${{ steps.prepare_tag.outputs.tag_name }}'
      - name: Upload message with Allure Report URL to Slack Channel
        if: always()
        uses: archive/github-actions-slack@v1.0.3
        id: notify
        with:
          slack-bot-user-oauth-access-token: ${{ secrets.SLACK_BOT_USER_OAUTH_ACCESS_TOKEN }}
          slack-channel: "automation-test-report"
          slack-text: New report available at https://vhslab.github.io/qa-automationtest/
      - name: Take Report Screenshot
        if: always()
        uses: swinton/screenshot-website@v1.x
        with:
          source: https://vhslab.github.io/qa-automationtest/
          destination: allure.png
          full-page: true
      - name: Upload Report Screenshot to Slack Channel
        if: always()
        uses: adrey/slack-file-upload-action@1.0.5
        with:
          token: ${{ secrets.SLACK_BOT_USER_OAUTH_ACCESS_TOKEN }}
          path: /home/runner/work/_temp/allure.png
          channel: automation-test-report
